#include <M5StickC.h>

#define IR_PIN 36

// --------------------
// Mode definitions
// --------------------
enum InputMode {
  MODE_FLAPPY = 0,
  MODE_ARC    = 1,
  MODE_DIST   = 2
};

InputMode mode = MODE_FLAPPY;

// --------------------
// Timing
// --------------------
unsigned long lastSend = 0;
const unsigned long interval = 20; // 50 Hz

void drawModeScreen() {
  M5.Lcd.fillScreen(BLACK);
  M5.Lcd.setTextSize(2);
  M5.Lcd.setCursor(10, 20);

  if (mode == MODE_FLAPPY) {
    M5.Lcd.setTextColor(CYAN, BLACK);
    M5.Lcd.println("FLAPPY");

    M5.Lcd.setTextColor(WHITE, BLACK);
    M5.Lcd.setTextSize(1);
    M5.Lcd.setCursor(10, 50);
    M5.Lcd.println("Tilt Control");
  }
  else if (mode == MODE_ARC) {
    M5.Lcd.setTextColor(YELLOW, BLACK);
    M5.Lcd.println("ARC BALL");

    M5.Lcd.setTextColor(WHITE, BLACK);
    M5.Lcd.setTextSize(1);
    M5.Lcd.setCursor(10, 50);
    M5.Lcd.println("Angle Control");
  }
  else if (mode == MODE_DIST) {
    M5.Lcd.setTextColor(GREEN, BLACK);
    M5.Lcd.println("DIST BALL");

    M5.Lcd.setTextColor(WHITE, BLACK);
    M5.Lcd.setTextSize(1);
    M5.Lcd.setCursor(10, 50);
    M5.Lcd.println("Distance Control");
  }
}

void setup() {
  M5.begin();
  M5.IMU.Init();
  Serial.begin(115200);

  M5.Lcd.setRotation(3);
  drawModeScreen();
}

void loop() {
  M5.update();

  // --------------------
  // Button A: switch mode
  // --------------------
  if (M5.BtnA.wasPressed()) {
    mode = (InputMode)((mode + 1) % 3);
    drawModeScreen();
  }

  // --------------------
  // Send data at fixed rate
  // --------------------
  if (millis() - lastSend < interval) return;
  lastSend = millis();

  float ax, ay, az;
  M5.IMU.getAccelData(&ax, &ay, &az);

  if (mode == MODE_FLAPPY) {
    // Flappy Bird (unchanged Unity)
    Serial.println(ay);
  }
  else if (mode == MODE_ARC) {
    // Arc Ball (unchanged Unity)
    float angle = -atan2(ax, ay) * 180.0 / PI;
    Serial.println(angle);
  }
  else if (mode == MODE_DIST) {
    // Distance Ball (unchanged Unity)
    int raw = analogRead(IR_PIN);
    raw = constrain(raw, 500, 3500);
    float dist = (raw - 500) / float(3500 - 500);
    Serial.println(dist);
  }
}
