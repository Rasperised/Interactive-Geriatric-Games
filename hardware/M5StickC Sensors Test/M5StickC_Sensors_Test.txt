#include <M5StickC.h>

float ax, ay, az;
float gx, gy, gz;
float tempC;

const int SCREEN_W = 160;
const int SCREEN_H = 80;

const int LEFT_X   = 2;
const int RIGHT_X  = 92;
const int LINE_H   = 10;
const int TOP_Y    = 0;
const int DIVIDER_X = 80;

void setup() {
  M5.begin();
  M5.Imu.Init();

  // --- Serial setup for Unity / debugging ---
  Serial.begin(115200);
  delay(1000);
  Serial.println("M5StickC IMU + Button Data Stream Started");

  // --- LCD setup ---
  M5.Lcd.setRotation(3);
  M5.Lcd.fillScreen(BLACK);
  M5.Lcd.setTextSize(1);
  M5.Lcd.setTextDatum(TL_DATUM);
  M5.Lcd.setTextWrap(false);
}

void loop() {
  M5.update();
  M5.Imu.getAccelData(&ax, &ay, &az);
  M5.Imu.getGyroData(&gx, &gy, &gz);
  M5.Imu.getTempData(&tempC);

  // ---------- SERIAL OUTPUT ----------
  Serial.print("ACC_X="); Serial.print(ax, 2); Serial.print(",");
  Serial.print("ACC_Y="); Serial.print(ay, 2); Serial.print(",");
  Serial.print("ACC_Z="); Serial.print(az, 2); Serial.print(",");

  Serial.print("GYRO_X="); Serial.print(gx, 2); Serial.print(",");
  Serial.print("GYRO_Y="); Serial.print(gy, 2); Serial.print(",");
  Serial.print("GYRO_Z="); Serial.print(gz, 2); Serial.print(",");

  Serial.print("TEMP="); Serial.print(tempC, 1); Serial.print(",");

  Serial.print("BTN_A="); Serial.print(M5.BtnA.isPressed() ? 1 : 0); Serial.print(",");
  Serial.print("BTN_B="); Serial.println(M5.BtnB.isPressed() ? 1 : 0);
  // (Each loop prints one line of all readings)

  // ---------- LCD DISPLAY ----------
  M5.Lcd.fillScreen(BLACK);
  M5.Lcd.drawFastVLine(DIVIDER_X - 1, 0, SCREEN_H, DARKGREY);

  int row = 0;
  M5.Lcd.setTextColor(WHITE, BLACK);
  M5.Lcd.drawString("Accel (g):", LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("X: " + String(ax, 1), LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("Y: " + String(ay, 1), LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("Z: " + String(az, 1), LEFT_X, TOP_Y + row*LINE_H); row++;

  M5.Lcd.drawString("Gyro (d/s):", LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("X: " + String(gx, 1), LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("Y: " + String(gy, 1), LEFT_X, TOP_Y + row*LINE_H); row++;
  M5.Lcd.drawString("Z: " + String(gz, 1), LEFT_X, TOP_Y + row*LINE_H);

  int rrow = 0;
  M5.Lcd.setTextColor(YELLOW, BLACK);
  M5.Lcd.drawString("Temp:", RIGHT_X, TOP_Y + rrow*LINE_H); rrow++;
  M5.Lcd.drawString(String(tempC, 1) + " C", RIGHT_X, TOP_Y + rrow*LINE_H); rrow++;

  rrow++;
  M5.Lcd.setTextColor(WHITE, BLACK);
  M5.Lcd.drawString("Buttons:", RIGHT_X, TOP_Y + rrow*LINE_H); rrow++;

  // Button A
  if (M5.BtnA.isPressed()) M5.Lcd.setTextColor(GREEN, BLACK);
  else M5.Lcd.setTextColor(RED, BLACK);
  M5.Lcd.drawString("A: " + String(M5.BtnA.isPressed() ? "ON" : "OFF"),
                    RIGHT_X, TOP_Y + rrow*LINE_H); rrow++;

  // Button B
  if (M5.BtnB.isPressed()) M5.Lcd.setTextColor(GREEN, BLACK);
  else M5.Lcd.setTextColor(RED, BLACK);
  M5.Lcd.drawString("B: " + String(M5.BtnB.isPressed() ? "ON" : "OFF"),
                    RIGHT_X, TOP_Y + rrow*LINE_H);

  delay(200);
}
